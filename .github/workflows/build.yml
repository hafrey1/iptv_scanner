name: Build IPTV Scanner (åŒç‰ˆæœ¬ç¼–è¯‘)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      create_release:
        description: 'æ˜¯å¦åˆ›å»º Release'
        required: true
        type: boolean
        default: true
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.0)'
        required: true
        type: string
        default: '1.0.0'

jobs:
  build-pyinstaller:
    name: PyInstaller ç¼–è¯‘ - æ ‡å‡†ç‰ˆ
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller aiohttp requests eventlet
    
    - name: ç¼–è¯‘ç¨‹åº (PyInstaller)
      run: |
        pyinstaller --onefile ^
                    --name="IPTV_Scanner" ^
                    iptv_scanner.py
      shell: cmd
      continue-on-error: true
    
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: IPTV_Scanner_PyInstaller
        path: dist/IPTV_Scanner.exe

  build-nuitka:
    name: Nuitka ç¼–è¯‘ - ä¼˜åŒ–ç‰ˆ
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: å®‰è£… C ç¼–è¯‘å™¨
      uses: ilammy/msvc-dev-cmd@v1
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install nuitka ordered-set zstandard
        pip install aiohttp requests eventlet
    
    - name: ç¼–è¯‘ç¨‹åº (Nuitka)
      run: |
        nuitka --standalone --onefile ^
               --assume-yes-for-downloads ^
               --windows-console-mode=attach ^
               --output-filename=IPTV_Scanner_Optimized.exe ^
               --company-name="IPTV Tools" ^
               --product-name="IPTV Scanner" ^
               --file-version=1.0.0 ^
               --product-version=1.0.0 ^
               --file-description="é«˜æ€§èƒ½ IPTV é¢‘é“æ‰«æå·¥å…·" ^
               iptv_scanner.py
      shell: cmd
    
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: IPTV_Scanner_Nuitka
        path: IPTV_Scanner_Optimized.exe

  create-release:
    name: åˆ›å»º Release
    needs: [build-pyinstaller, build-nuitka]
    runs-on: ubuntu-latest
    if: (startsWith(github.ref, 'refs/tags/')) || (github.event_name == 'workflow_dispatch' && inputs.create_release == true)
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: ä¸‹è½½ PyInstaller ç¼–è¯‘äº§ç‰©
      uses: actions/download-artifact@v4
      with:
        name: IPTV_Scanner_PyInstaller
        path: ./release
      continue-on-error: true
    
    - name: ä¸‹è½½ Nuitka ç¼–è¯‘äº§ç‰©
      uses: actions/download-artifact@v4
      with:
        name: IPTV_Scanner_Nuitka
        path: ./release
    
    - name: é‡å‘½åæ–‡ä»¶
      run: |
        cd release
        if [ -f "IPTV_Scanner.exe" ]; then
          mv IPTV_Scanner.exe IPTV_Scanner_Standard.exe
        fi
        ls -lh
      shell: bash
    
    - name: åˆ›å»º Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.ref_name != '' && github.ref_name || format('v{0}', inputs.version) }}
        name: ${{ github.ref_name != '' && github.ref_name || format('Release v{0}', inputs.version) }}
        files: |
          release/IPTV_Scanner_Standard.exe
          release/IPTV_Scanner_Optimized.exe
          config.json
        body: |
          ## ğŸš€ IPTV Scanner - åŒç‰ˆæœ¬å‘å¸ƒ
          
          ### ğŸ“¦ ç‰ˆæœ¬è¯´æ˜
          
          **æ ‡å‡†ç‰ˆ (PyInstaller)** - `IPTV_Scanner_Standard.exe`
          - âœ… å…¼å®¹æ€§æœ€å¥½ï¼Œç¨³å®šå¯é 
          - âœ… ç¼–è¯‘é€Ÿåº¦å¿«ï¼ˆçº¦ 2-3 åˆ†é’Ÿï¼‰
          - âš ï¸ ä½“ç§¯è¾ƒå¤§ï¼ˆçº¦ 15-20 MBï¼‰
          - âš ï¸ å¯åŠ¨ç¨æ…¢
          
          **ä¼˜åŒ–ç‰ˆ (Nuitka)** - `IPTV_Scanner_Optimized.exe` â­ æ¨è
          - âš¡ å¯åŠ¨é€Ÿåº¦æå‡ 2-3 å€
          - ğŸš„ è¿è¡Œæ€§èƒ½æå‡ 30-70%
          - ğŸ“¦ ä½“ç§¯å‡å° 40-60%ï¼ˆçº¦ 8-12 MBï¼‰
          - ğŸ”’ ä»£ç ç¼–è¯‘ä¿æŠ¤
          - ğŸ’¾ å†…å­˜ä½¿ç”¨æ›´ä¼˜åŒ–
          
          ### ğŸ“¥ ä½¿ç”¨æ–¹æ³•
          1. æ ¹æ®éœ€è¦ä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„ exe æ–‡ä»¶
          2. ä¸‹è½½ `config.json` é…ç½®æ–‡ä»¶
          3. å°† exe å’Œ config.json æ”¾åœ¨åŒä¸€ç›®å½•
          4. åŒå‡»è¿è¡Œ exe æ–‡ä»¶
          
          ### âš™ï¸ é…ç½®è¯´æ˜
          ç¼–è¾‘ `config.json` å¯è‡ªå®šä¹‰ï¼š
          - æ‰«æè¶…æ—¶æ—¶é—´å’Œå¹¶å‘æ•°
          - URL æ‰«æåˆ—è¡¨
          - è¾“å‡ºæ–‡ä»¶æ ¼å¼å’Œåç§°
          - é¢‘é“åç§°æ›¿æ¢è§„åˆ™
          
          ### ğŸ’¡ é€‰æ‹©å»ºè®®
          - **æ—¥å¸¸ä½¿ç”¨**ï¼šæ¨èä¼˜åŒ–ç‰ˆï¼ˆæ›´å¿«æ›´å°ï¼‰
          - **å…¼å®¹æ€§ä¼˜å…ˆ**ï¼šé€‰æ‹©æ ‡å‡†ç‰ˆ
          - **ä¸ç¡®å®š**ï¼šä¸¤ä¸ªéƒ½è¯•è¯•ï¼Œçœ‹å“ªä¸ªæ›´é€‚åˆä½ 
      env:
        GITHUB_TOKEN: $ secrets.GITHUB_TOKEN 
